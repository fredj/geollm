<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoLLM Demo</title>
    <!-- OpenLayers CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v10.8.0/ol.css"
      type="text/css"
    />
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      .osm-layer {
        filter: grayscale(1);
      }
      .search-container {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 10px;
      }
      input[type="text"] {
        padding: 10px;
        width: 500px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
      }
      button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #0056b3;
      }
      #status {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
        text-align: center;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <div class="search-container">
      <input
        type="text"
        id="queryInput"
        placeholder="e.g., in the heart of Bern"
        value="in the heart of Bern"
      />
      <button onclick="executeQuery()">Search</button>
      <div id="status"></div>
    </div>
    <div id="map"></div>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.8.0/dist/ol.js"></script>
    <script>
      // Initialize Map
      const map = new ol.Map({
        target: "map",
        layers: [
          new ol.layer.Tile({
            className: "osm-layer",
            source: new ol.source.OSM(),
          }),
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([8.2275, 46.8182]), // Switzerland
          zoom: 8,
        }),
      });

      // Layer for search results (more visible) and reference features (less visible)
      const vectorSource = new ol.source.Vector();
      const vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: [
          {
            filter: ['==', ['get', 'role'], 'search_area'],
            style: {
              'stroke-color': '#03B000',
              'stroke-width': 3,
              'fill-color': 'rgba(3, 176, 0, 0.15)',
              'circle-radius': 7,
              'circle-fill-color': '#03B000',
              'circle-stroke-color': '#029000',
              'circle-stroke-width': 2,
            },
          },
          {
            // Default style for reference features
            filter: ['!=', ['get', 'role'], 'search_area'],
            style: {
              'stroke-color': '#8E8B8B',
              'stroke-width': 2,
              'fill-color': 'rgba(3, 0, 176, 0.1)',
              'circle-radius': 5,
              'circle-fill-color': '#CFCECD',
              'circle-stroke-color': '#8E8B8B',
              'circle-stroke-width': 1,
            },
          },
        ],
      });
      map.addLayer(vectorLayer);

      async function executeQuery() {
        const query = document.getElementById("queryInput").value;
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = "Processing...";
        statusDiv.className = "";
        vectorSource.clear();

        try {
          const response = await fetch("/api/query", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ query: query }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Failed to process query");
          }

          const data = await response.json();

          console.log(data.geo_query);

          // Add features to map
          const format = new ol.format.GeoJSON({
            dataProjection: "EPSG:4326",
            featureProjection: "EPSG:3857",
          });

          const features = format.readFeatures(data.result);
          vectorSource.addFeatures(features);

          // Zoom to extent
          if (features.length > 0) {
            const extent = vectorSource.getExtent();
            map.getView().fit(extent, {
              padding: [50, 50, 50, 50],
              duration: 1000,
              maxZoom: 14,
            });

            const relation = data.geo_query.spatial_relation.relation;
            statusDiv.innerHTML = `Found: <strong>${data.geo_query.reference_location.name}</strong> (${relation})`;
          } else {
            statusDiv.textContent = "No results found.";
          }
        } catch (err) {
          statusDiv.textContent = err.message;
          statusDiv.className = "error";
          console.error(err);
        }
      }
    </script>
  </body>
</html>
